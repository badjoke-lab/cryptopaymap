<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Report / Other Proposal ‚Äî CryptoPayMap</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="/forms/forms.css" />
  <style>
    /* confirm modal */
    .confirm-modal{position:fixed;inset:0;background:rgba(15,23,42,.48);display:none;place-items:center;z-index:9999}
    .confirm-card{background:#fff;border-radius:12px;max-width:720px;width:92%;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,.25);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto}
    .confirm-card h2{margin:0 0 12px}
    .confirm-card .grid{display:grid;grid-template-columns:180px 1fr;gap:8px 12px;margin:12px 0}
    .confirm-card .warnings{background:#fff7ed;border:1px solid #fdba74;color:#7c2d12;padding:10px;border-radius:8px;margin-bottom:10px}

    /* submitting overlay */
    .cpm-progress{position:fixed;inset:0;display:none;place-items:center;background:rgba(15,23,42,.55);z-index:10000}
    .cpm-progress .box{width:min(560px,92%);background:#fff;border-radius:14px;padding:18px 20px;box-shadow:0 10px 30px rgba(0,0,0,.25);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto}
    .cpm-progress h3{margin:0 0 8px;font-size:16px}
    .cpm-bar{height:8px;background:#e5e7eb;border-radius:999px;overflow:hidden}
    .cpm-bar>span{display:block;height:100%;width:0%;background:#3b82f6;border-radius:999px;transition:width .4s ease}
    .cpm-msg{margin:10px 0 0;color:#475569;font-size:13px}

    /* (debug) small helper panel (off by default) */
    #form-prefill-debug{position:relative;border:1px solid #e6eef6;background:#f8fafc;color:#0f172a;padding:10px;font-size:13px;margin:8px 0}
    #form-debug-toggle{display:inline-block;margin-left:8px;cursor:pointer;font-size:13px;color:#0366d6;text-decoration:underline}
    #form-debug-float{position:fixed;right:12px;bottom:12px;z-index:9999;background:rgba(0,0,0,.7);color:#fff;padding:6px 10px;border-radius:8px;font-size:12px;cursor:pointer;display:none}
  </style>
</head>
<body>
<main class="container">
  <h1>Report / Other Proposal</h1>
  <p class="subtle">Images: up to <strong>4</strong>, ‚â§ <strong>2MB</strong> each. Evidence links are recommended.</p>

  <form id="form-report" action="/submit/report" method="post" enctype="multipart/form-data" class="form-col">
    <div class="field"><label class="required" for="sn">Submitter name</label><input id="sn" name="SubmitterName" required minlength="2" maxlength="80" type="text"></div>
    <div class="field"><label class="required" for="se">Submitter email</label><input id="se" name="SubmitterEmail" required type="email"></div>

    <div class="field"><label class="required" for="pr">Map URL or Place ID</label><input id="pr" name="PlaceRef" required placeholder="https://cryptopaymap.vercel.app/place/xxxx" type="text"></div>
    <div class="field"><label for="pn">Place name</label><input id="pn" name="PlaceName" maxlength="80" type="text"></div>

    <div class="field"><label class="required" for="iss">Issue type</label>
      <select id="iss" name="Issue" required>
        <option value="">‚Äî Select ‚Äî</option>
        <option>Closed</option><option>Wrong info</option><option>Duplicate</option><option>Fraud</option><option>Other</option>
      </select>
    </div>

    <div class="field"><label class="required" for="det">Description / Details</label><textarea id="det" name="Details" required placeholder="Describe the issue..."></textarea></div>
    <div class="field"><label for="ev">Evidence link(s)</label><textarea id="ev" name="Evidence" placeholder="https://x.com/post/..., https://instagram.com/..."></textarea></div>

    <div class="field"><label for="nc">New accepted crypto</label><input id="nc" name="NewCoins" placeholder="USDT (Polygon)" type="text"></div>
    <div class="field"><label for="op">Other proposal (free text)</label><textarea id="op" name="OtherProposal" placeholder="Any additional notes or proposals‚Ä¶"></textarea></div>

    <div class="field">
      <label>üñºÔ∏è Upload evidence images ‚Äî gallery (up to 4)</label>
      <div class="drop" data-max="4" data-input="galleryR">
        <div class="header">
          <button type="button" class="btn secondary dz-add">Add images</button>
          <button type="button" class="btn secondary dz-clear">Clear all</button>
          <span class="counter dz-counter">0 / 4 selected</span>
        </div>
        <div class="area dz-area">Drag & drop images here, or click to select.</div>
        <input id="galleryR" name="Gallery[]" type="file" accept="image/jpeg,image/png,image/webp" multiple hidden />
        <p class="help">Images only. ‚â§2MB each. Drag to reorder. <strong>First image will be used as cover.</strong></p>
        <div class="thumb-list dz-list"></div>
      </div>
    </div>

    <div class="field"><label for="ce">Contact email (optional)</label><input id="ce" type="email" name="Contact"></div>

    <div class="field inline-check">
      <input id="consent" name="Consent" type="checkbox" required />
      <label class="required" for="consent" style="font-weight:400">
        I confirm the information is accurate and I grant a non-exclusive free license to display the content.
      </label>
    </div>

    <div class="btnrow">
      <button class="btn" type="button" id="btn-review">Review & Confirm</button>
      <a class="btn secondary" href="/forms/owner.html">Switch to Owner</a>
      <a class="btn secondary" href="/forms/community.html">Switch to Community</a>
    </div>
  </form>
</main>

<!-- confirm modal -->
<div id="confirmModal" class="confirm-modal">
  <div class="confirm-card">
    <h2>Confirm your submission</h2>
    <div id="confirmWarnings" class="warnings" style="display:none;"></div>
    <div class="grid">
      <div><strong>Kind</strong></div><div>report</div>
      <div><strong>Place</strong></div><div id="c_place">‚Äî</div>
      <div><strong>PlaceRef</strong></div><div id="c_ref">‚Äî</div>
      <div><strong>Issue</strong></div><div id="c_issue">‚Äî</div>
      <div><strong>Details</strong></div><div id="c_details">‚Äî</div>
      <div><strong>Evidence</strong></div><div id="c_evidence">‚Äî</div>
      <div><strong>New coins</strong></div><div id="c_newcoins">‚Äî</div>
      <div><strong>Other proposal</strong></div><div id="c_other">‚Äî</div>
      <div><strong>Images</strong></div><div id="c_imgs">0</div>
    </div>
    <div class="btnrow">
      <button type="button" class="btn secondary" id="btn-back">Back & Edit</button>
      <button type="button" class="btn" id="btn-submit-final">Submit</button>
    </div>
  </div>
</div>

<!-- floating debug toggle (off by default) -->
<div id="form-debug-float" title="Toggle prefill debug panel">Debug</div>

<script>
/* Prefill + debug (same style as owner/community) */
(function(){
  function onReady(fn){ if(document.readyState==='loading') document.addEventListener('DOMContentLoaded',fn); else fn(); }
  const DEBUG = false;

  onReady(function(){
    try{
      const sp = new URLSearchParams(location.search);
      const placeId = sp.get('placeId') || sp.get('place_id') || '';
      const placeName = sp.get('placeName') || sp.get('place_name') || '';

      function setField(possibleNames, val){
        if(!val) return false;
        for(const n of possibleNames){
          let el = document.querySelector(`[name="${n}"]`) || document.getElementById(n);
          if(!el){
            el = document.querySelector(`[name="${n.toLowerCase()}"]`) || document.getElementById(n.toLowerCase());
          }
          if(!el) continue;
          if(el.tagName === 'INPUT' || el.tagName === 'TEXTAREA' || el.tagName === 'SELECT'){
            el.value = val;
            el.dispatchEvent(new Event('input', { bubbles: true }));
            el.dispatchEvent(new Event('change', { bubbles: true }));
          } else {
            el.textContent = val;
          }
          return true;
        }
        return false;
      }

      setField(['PlaceName','place_name','pn','BusinessName','Business','bn','name'], placeName);
      setField(['PlaceRef','Place','placeRef','place_ref','pr','place','place_id','placeId'], placeId || '');

      if(placeId){
        const form = document.getElementById('form-report');
        if(form){
          let hi = form.querySelector('input[name="placeId"]');
          if(!hi){
            hi = document.createElement('input');
            hi.type = 'hidden';
            hi.name = 'placeId';
            form.appendChild(hi);
          }
          hi.value = placeId;
        }
      }

      // Debug panel (disabled by default)
      if(DEBUG){
        const infoId = 'form-prefill-debug';
        if(!document.getElementById(infoId)){
          const info = document.createElement('div');
          info.id = infoId;
          info.innerHTML = '<div><strong>Prefill debug</strong><span id="form-debug-toggle">show</span></div><div id="form-prefill-content" style="margin-top:8px; display:none;"><div><strong>placeId</strong>: <span id="dbg-placeId"></span></div><div><strong>placeName</strong>: <span id="dbg-placeName"></span></div><div><strong>PlaceRef field value</strong>: <span id="dbg-pr"></span></div><div><strong>PlaceName field value</strong>: <span id="dbg-pn"></span></div></div>';
          const container = document.querySelector('main.container') || document.body;
          container.insertBefore(info, container.firstChild);
          function refreshDbg(){
            document.getElementById('dbg-placeId').textContent = placeId || '(none)';
            document.getElementById('dbg-placeName').textContent = placeName || '(none)';
            document.getElementById('dbg-pr').textContent = (document.getElementById('pr') || { value: '' }).value;
            document.getElementById('dbg-pn').textContent = (document.getElementById('pn') || { value: '' }).value;
          }
          refreshDbg();
          const tgl = document.getElementById('form-debug-toggle');
          const content = document.getElementById('form-prefill-content');
          tgl.addEventListener('click', function(){
            if(content.style.display === 'none'){ content.style.display = ''; tgl.textContent = 'hide'; }
            else { content.style.display = 'none'; tgl.textContent = 'show'; }
          });
          const floatBtn = document.getElementById('form-debug-float');
          if(floatBtn){
            floatBtn.style.display = 'inline-block';
            floatBtn.addEventListener('click', () => {
              if(content.style.display === 'none'){ content.style.display = ''; tgl.textContent = 'hide'; }
              else { content.style.display = 'none'; tgl.textContent = 'show'; }
            });
          }
        }
      }
    }catch(e){ console.error('report prefill error', e); }
  });
})();
</script>

<script>
/* Dropzone / gallery (same as owner/community) */
(function(){
  function initDrop(el){
    const max=parseInt(el.dataset.max||'4',10);
    const input=document.getElementById(el.dataset.input);
    const add=el.querySelector('.dz-add'), clr=el.querySelector('.dz-clear'),
          area=el.querySelector('.dz-area'), list=el.querySelector('.dz-list'),
          counter=el.querySelector('.dz-counter');
    let files=[];
    const fmt=n=>n>=1048576?(n/1048576).toFixed(2)+'MB':Math.round(n/1024)+'KB';
    const sync=()=>{const dt=new DataTransfer();files.slice(0,max).forEach(f=>dt.items.add(f));input.files=dt.files;counter.textContent=`${files.length} / ${max} selected`;}
    const card=(f,i)=>{const d=document.createElement('div');d.className='thumb';d.draggable=true;d.dataset.i=i;
      const im=document.createElement('img');im.src=URL.createObjectURL(f);
      const m=document.createElement('div');m.className='meta';m.innerHTML=`<div class="name">${f.name}</div><div class="cap">${i===0?'<span class="good">Cover ¬∑ </span>':''}${fmt(f.size)}</div>`;
      const x=document.createElement('button');x.className='del';x.type='button';x.textContent='√ó';x.onclick=()=>{files.splice(i,1);render();};
      d.append(im,m,x);
      d.addEventListener('dragstart',e=>{d.classList.add('dragging');e.dataTransfer.setData('text/plain',i)});
      d.addEventListener('dragend',()=>d.classList.remove('dragging'));
      d.addEventListener('dragover',e=>e.preventDefault());
      d.addEventListener('drop',e=>{e.preventDefault();const from=+e.dataTransfer.getData('text/plain');const f2=files.splice(from,1)[0];files.splice(i,0,f2);render();});
      return d;
    };
    function render(){ list.innerHTML=''; files.forEach((f,i)=>list.appendChild(card(f,i))); sync(); }
    function accept(fs){ const add=[]; for(const f of fs){ if(!/image\/(jpeg|png|webp)/.test(f.type)) continue; if(f.size>2*1024*1024) continue; if(files.length+add.length>=max) break; add.push(f);} if(add.length){ files=files.concat(add); render(); } }
    add.onclick=()=>input.click(); clr.onclick=()=>{files=[];render();}; input.onchange=()=>accept(input.files||[]);
    area.onclick=()=>input.click(); area.ondragover=e=>{e.preventDefault();area.classList.add('dragover')}; area.ondragleave=()=>area.classList.remove('dragover');
    area.ondrop=e=>{e.preventDefault();area.classList.remove('dragover');accept(e.dataTransfer.files||[])};
    render();
  }
  document.querySelectorAll('.drop').forEach(initDrop);
})();
</script>

<!-- Confirm + Progress overlay -->
<script>
(function(){
  function onReady(fn){ if(document.readyState==='loading') document.addEventListener('DOMContentLoaded',fn); else fn(); }
  onReady(function(){
    try{
      const form = document.getElementById('form-report');
      const btnReview = document.getElementById('btn-review');
      const modal = document.getElementById('confirmModal');
      const warnBox = document.getElementById('confirmWarnings');
      const btnBack = document.getElementById('btn-back');
      const btnSubmit = document.getElementById('btn-submit-final');

      function txt(n){ const el=form.querySelector(`[name="${n}"]`); return (el&&el.value||'').trim(); }
      function sel(n){ const el=form.querySelector(`[name="${n}"]`); return el && el.tagName==='SELECT' ? el.value : (el&&el.value||''); }
      function countImgs(){ const fi=form.querySelector('#galleryR'); return (fi&&fi.files&&fi.files.length)||0; }

      function buildConfirm(){
        document.getElementById('c_place').textContent = txt('PlaceName') || '‚Äî';
        document.getElementById('c_ref').textContent = txt('PlaceRef') || '‚Äî';
        document.getElementById('c_issue').textContent = sel('Issue') || '‚Äî';
        document.getElementById('c_details').textContent = txt('Details') || '‚Äî';
        document.getElementById('c_evidence').textContent = txt('Evidence') || '‚Äî';
        document.getElementById('c_newcoins').textContent = txt('NewCoins') || '‚Äî';
        document.getElementById('c_other').textContent = txt('OtherProposal') || '‚Äî';
        document.getElementById('c_imgs').textContent = String(countImgs());

        const missing = [];
        ['SubmitterName','SubmitterEmail','PlaceRef','Issue','Details'].forEach(n=>{ if(!txt(n) && !sel(n)) missing.push(n); });

        const warns = [];
        if(missing.length) warns.push('Missing required: ' + missing.join(', '));
        if(warns.length){ warnBox.style.display='block'; warnBox.innerHTML = warns.map(s=>`<div>${s}</div>`).join(''); }
        else { warnBox.style.display='none'; warnBox.innerHTML=''; }
      }

      // ---- Progress overlay
      const ov = document.createElement('div');
      ov.id = 'cpmProgress';
      ov.className = 'cpm-progress';
      ov.innerHTML = '<div class="box"><h3>Submitting‚Ä¶</h3><div class="cpm-bar"><span id="cpmBar"></span></div><div id="cpmMsg" class="cpm-msg">Uploading files and creating a review PR‚Ä¶</div></div>';
      document.body.appendChild(ov);
      const bar = ()=>document.getElementById('cpmBar');
      let timer=null;
      function showProgress(msg){
        const m=document.getElementById('cpmMsg');
        if(m) m.textContent = msg || 'Submitting‚Ä¶';
        ov.style.display='grid';
        let p=8; bar().style.width='8%';
        timer = setInterval(()=>{ p=Math.min(p+(p<70?Math.random()*10+5:Math.random()*5+1),94); bar().style.width=p+'%'; }, 600);
        document.body.style.overflow='hidden';
      }
      function hideProgress(){
        if(timer) clearInterval(timer);
        ov.style.display='none';
        document.body.style.overflow='';
      }
      function lockButtons(lock){
        if(btnSubmit) btnSubmit.disabled = lock;
        if(btnReview) btnReview.disabled = lock;
      }

      btnReview?.addEventListener('click', ()=>{ buildConfirm(); modal.style.display='grid'; document.body.style.overflow='hidden'; });
      btnBack?.addEventListener('click', ()=>{ modal.style.display='none'; document.body.style.overflow=''; });
      btnSubmit?.addEventListener('click', ()=>{
        modal.style.display='none';
        showProgress('Uploading files and creating a review PR‚Ä¶');
        lockButtons(true);
        form.submit(); // POST ‚Üí server 302 ‚Üí /forms/submitted.html
      });

      // Áõ¥Êé• submit „Åß„ÇÇ„Ç™„Éº„Éê„Éº„É¨„Ç§
      form.addEventListener('submit', ()=>{
        showProgress('Uploading files and creating a review PR‚Ä¶');
        lockButtons(true);
      });
    }catch(e){ console.error('report confirm/progress init error', e); }
  });
})();
</script>
</body>
</html>

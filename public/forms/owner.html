<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Owner Submission ‚Äî CryptoPayMap</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="/forms/forms.css" />
  <style>
    /* confirm modal */
    .confirm-modal{position:fixed;inset:0;background:rgba(15,23,42,.48);display:none;place-items:center;z-index:9999}
    .confirm-card{background:#fff;border-radius:12px;max-width:720px;width:92%;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,.25);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto}
    .confirm-card h2{margin:0 0 12px}
    .confirm-card .grid{display:grid;grid-template-columns:180px 1fr;gap:8px 12px;margin:12px 0}
    .confirm-card .warnings{background:#fff7ed;border:1px solid #fdba74;color:#7c2d12;padding:10px;border-radius:8px;margin-bottom:10px}

    /* submitting overlay */
    .cpm-progress{position:fixed;inset:0;display:none;place-items:center;background:rgba(15,23,42,.55);z-index:10000}
    .cpm-progress .box{width:min(560px,92%);background:#fff;border-radius:14px;padding:18px 20px;box-shadow:0 10px 30px rgba(0,0,0,.25);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto}
    .cpm-progress h3{margin:0 0 8px;font-size:16px}
    .cpm-bar{height:8px;background:#e5e7eb;border-radius:999px;overflow:hidden}
    .cpm-bar>span{display:block;height:100%;width:0%;background:#3b82f6;border-radius:999px;transition:width .4s ease}
    .cpm-msg{margin:10px 0 0;color:#475569;font-size:13px}
  </style>
</head>
<body>
<main class="container">
  <h1>Owner Submission</h1>
  <p class="form-desc">
    <strong>For business owners or official representatives.</strong><br>
    Use this form to <strong>register your own business</strong> that accepts crypto payments.<br>
    Please provide accurate information ‚Äî including address, accepted crypto, and proof (POS or payment page).<br>
    Submitted data will appear on CryptoPayMap after verification.<br>
    Upload clear, up-to-date photos (storefront, menu, payment screen) to help users identify your store.
  </p>

  <p class="subtle">Required fields <strong>*</strong>. Images: up to <strong>8</strong>, ‚â§ <strong>2MB</strong> each. EXIF removed.</p>

  <form id="form-owner" action="/submit/owner" method="post" enctype="multipart/form-data" class="form-col">
    <!-- Submitter -->
    <div class="field">
      <label class="required" for="sn">Submitter name</label>
      <input id="sn" name="SubmitterName" required minlength="2" maxlength="80" type="text">
    </div>
    <div class="field">
      <label class="required" for="se">Submitter email</label>
      <input id="se" name="SubmitterEmail" required type="email">
    </div>

    <!-- Business core -->
    <div class="field">
      <label class="required" for="bn">Business name</label>
      <input id="bn" name="BusinessName" required maxlength="80" type="text">
    </div>

    <!-- Optional existing ID (visible). Hidden canonical 'placeId' is injected by the prefill script. -->
    <div class="field">
      <label for="existingId">Existing place ID (optional)</label>
      <input id="existingId" name="ExistingPlaceId" type="text" placeholder="e.g. cpm:jp-tokyo-satoshi-coffee-1 or osm:node:10078071561" />
      <p class="help">If you want to edit an already-listed place, enter its ID here. Leave blank to create a new listing.</p>
    </div>

    <!-- Country select (populated) + hidden CountryCode -->
    <div class="field">
      <label class="required" for="ctr">Country</label>
      <select id="ctr" name="Country" required>
        <option value="">‚Äî Loading countries‚Ä¶ ‚Äî</option>
      </select>
      <input type="hidden" id="ctrCode" name="CountryCode" />
      <p class="help">Type to search. Shows ‚ÄúName (CC)‚Äù. The submitted value is the full country name.</p>
    </div>

    <!-- City -->
    <div class="field">
      <label class="required" for="cty">City</label>
      <input id="cty" name="City" required maxlength="64" type="text">
    </div>

    <div class="field">
      <label class="required" for="addr">Address</label>
      <input id="addr" name="Address" required maxlength="200" type="text" placeholder="Street, number, building, floor, etc.">
    </div>

    <!-- Website -->
    <div class="field">
      <label for="web">Website / Map URL</label>
      <input id="web" name="Website" type="url" placeholder="https://...">
    </div>

    <!-- About / Summary (optional) -->
    <div class="field">
      <label for="about">About / Summary (optional) <span id="about_left" class="subtle">(0 / 600)</span></label>
      <textarea id="about" name="About" maxlength="600" placeholder="Describe your business (‚â§600 chars for Owner)"></textarea>
      <p class="help">Shown in the ‚ÄúAbout‚Äù section on the detail modal. Owner submissions: up to 600 characters (Community: 300).</p>
    </div>

    <!-- Optional coordinates (still optional) -->
    <div class="field">
      <label for="lat">Latitude (optional)</label>
      <input id="lat" name="lat" type="number" step="0.0000001" min="-90" max="90" placeholder="e.g. 35.658034" inputmode="decimal">
    </div>
    <div class="field">
      <label for="lng">Longitude (optional)</label>
      <input id="lng" name="lng" type="number" step="0.0000001" min="-180" max="180" placeholder="e.g. 139.701636" inputmode="decimal">
    </div>

    <!-- Category -->
    <div class="field">
      <label class="required" for="cat">Category</label>
      <select id="cat" name="Category" required>
        <option value="">‚Äî Select ‚Äî</option>
        <option>Cafe</option><option>Restaurant</option><option>Bar / Pub</option><option>Bakery</option>
        <option>Grocery / Supermarket</option><option>Butcher</option><option>Pharmacy</option><option>Clinic / Doctors</option>
        <option>Dentist</option><option>Hairdresser / Barber</option><option>Spa / Beauty</option><option>Electronics</option>
        <option>Clothing / Apparel</option><option>Jewelry</option><option>Bookshop</option><option>Convenience store</option>
        <option>Hotel / Lodging</option><option>Gym / Fitness</option><option>Dance school / Studio</option>
        <option>Tool / Equipment rental</option><option>Coworking / Office</option><option>Other</option>
      </select>
    </div>
    <div class="field">
      <label for="catO">Category (Other)</label>
      <input id="catO" name="CategoryOther" maxlength="100" placeholder="Describe briefly (‚â§100 chars)" type="text">
    </div>

    <!-- Contact -->
    <div class="field">
      <label for="hrs">Opening hours</label>
      <textarea id="hrs" name="Hours" placeholder="Mon‚ÄìFri 10:00‚Äì18:00"></textarea>
    </div>
    <div class="field">
      <label for="tel">Contact / Phone</label>
      <input id="tel" name="Phone" type="tel" placeholder="+1 555 123 4567">
    </div>

    <!-- Socials -->
    <div class="field">
      <label for="soc">Social links</label>
      <textarea id="soc" name="Socials" placeholder="https://instagram.com/..., @handle, https://x.com/..."></textarea>
      <p class="help">Separate by new lines / commas / ‚Äú|‚Äù. Use URL or @handle.</p>
    </div>

    <!-- Payments -->
    <div class="field">
      <label class="required" for="acc">Accepted crypto</label>
      <textarea id="acc" name="Accepted" required placeholder="BTC, ETH, USDT (Polygon)"></textarea>
      <p class="help">List primary assets and chains. Example: ‚ÄúBTC, ETH, USDT (Polygon)‚Äù.</p>
    </div>

    <div class="field">
      <label for="ppg">Payment page / instructions URLs</label>
      <textarea id="ppg" name="PaymentPages" placeholder="https://example.com/pay, https://example.com/how-to-pay"></textarea>
      <p class="help">If you chose ‚ÄúOfficial payment page URL‚Äù as proof, please provide at least one URL.</p>
    </div>

    <div class="field">
      <label for="paynote">Payments note (optional) <span id="pay_left" class="subtle">(0 / 150)</span></label>
      <textarea id="paynote" name="PaymentNote" maxlength="150" placeholder="Min. order for crypto, tipping policy, Lightning preferred, etc. (‚â§150 chars)"></textarea>
    </div>

    <!-- Amenities: notes only -->
    <div class="field">
      <label for="amen_notes">Amenities notes (optional) <span id="amen_left" class="subtle">(0 / 150)</span></label>
      <textarea id="amen_notes" name="amenities_notes" maxlength="150" placeholder="WiFi/Seating/outlets/stroller route/smoking path, etc. (‚â§150 chars)"></textarea>
      <p class="help">Appears in the ‚ÄúAmenities‚Äù section. <strong>Limited to 150 characters</strong>. No checkboxes ‚Äî free text only.</p>
    </div>

    <!-- Proof -->
    <div class="field">
      <label class="required" for="prf">Ownership proof (pick one)</label>
      <select id="prf" name="Proof" required>
        <option value="">‚Äî Select ‚Äî</option>
        <option>Domain verification (.well-known or meta tag)</option>
        <option>Official payment page URL</option>
        <option>Business email @domain</option>
        <option>POS/receipt photo (separate field)</option>
        <option>Other</option>
      </select>
    </div>

    <!-- Images -->
    <div class="field">
      <label for="proofimg">üìÑ Proof image ‚Äî POS / receipt (single)</label>
      <input id="proofimg" name="ProofImage" type="file" accept="image/*" />
      <p class="help">Use only for verification evidence. Do not mix with gallery below. ‚â§2MB.</p>
    </div>

    <div class="field">
      <label>üñºÔ∏è Gallery images ‚Äî up to 8</label>
      <div class="drop" data-max="8" data-input="gallery8">
        <div class="header">
          <button type="button" class="btn secondary dz-add">Add images</button>
          <button type="button" class="btn secondary dz-clear">Clear all</button>
          <span class="counter dz-counter">0 / 8 selected</span>
        </div>
        <div class="area dz-area">Drag & drop images here, or click to select.</div>
        <input id="gallery8" name="Gallery[]" type="file" accept="image/jpeg,image/png,image/webp" multiple hidden />
        <p class="help">Images only. ‚â§2MB each. Drag thumbnails to reorder. <strong>First image will be used as cover.</strong></p>
        <div class="thumb-list dz-list"></div>
      </div>
    </div>

    <!-- Gallery captions -->
    <div class="field">
      <label for="captions">Gallery captions (optional)</label>
      <textarea id="captions" name="GalleryCaptions" placeholder="One line per image, in the same order as selected"></textarea>
      <p class="help">Lines map to images by order. Extra lines are ignored; missing lines mean no caption.</p>
    </div>

    <!-- Consent -->
    <div class="field inline-check">
      <input id="consent" name="Consent" type="checkbox" required />
      <label class="required" for="consent" style="font-weight:400">
        I confirm the provided info is accurate and I grant a non-exclusive free license to display the content.
      </label>
    </div>

    <div class="btnrow">
      <button class="btn" type="button" id="btn-review">Review & Confirm</button>
      <a class="btn secondary" href="/forms/community.html">Switch to Community</a>
      <a class="btn secondary" href="/forms/report.html">Switch to Report</a>
    </div>
  </form>
</main>

<!-- confirm modal -->
<div id="confirmModal" class="confirm-modal">
  <div class="confirm-card">
    <h2>Confirm your submission</h2>
    <div id="confirmWarnings" class="warnings" style="display:none;"></div>
    <div class="grid">
      <div><strong>Kind</strong></div><div>owner</div>
      <div><strong>Business</strong></div><div id="c_business">‚Äî</div>
      <div><strong>City</strong></div><div id="c_city">‚Äî</div>
      <div><strong>Country</strong></div><div id="c_country">‚Äî</div>
      <div><strong>Address</strong></div><div id="c_address">‚Äî</div>
      <div><strong>Category</strong></div><div id="c_category">‚Äî</div>
      <div><strong>Accepted</strong></div><div id="c_accepted">‚Äî</div>
      <div><strong>About</strong></div><div id="c_about">‚Äî</div>
      <div><strong>Payment note</strong></div><div id="c_paynote">‚Äî</div>
      <div><strong>Amenities notes</strong></div><div id="c_amen">‚Äî</div>
      <div><strong>Images</strong></div><div id="c_imgs">0</div>
    </div>
    <div class="btnrow">
      <button type="button" class="btn secondary" id="btn-back">Back & Edit</button>
      <button type="button" class="btn" id="btn-submit-final">Submit</button>
    </div>
  </div>
</div>

<!-- Dropzone mini -->
<script>
  (function(){
    const cat=document.getElementById('cat'), other=document.getElementById('catO');
    function t(){ const on=cat.value==='Other'; other.disabled=!on; if(!on) other.value=''; }
    cat?.addEventListener('change',t); t();
  })();
  function initDrop(el){
    const max=parseInt(el.dataset.max||'8',10);
    const input=document.getElementById(el.dataset.input);
    const add=el.querySelector('.dz-add'), clr=el.querySelector('.dz-clear'),
          area=el.querySelector('.dz-area'), list=el.querySelector('.dz-list'),
          counter=el.querySelector('.dz-counter');
    let files=[];
    const fmt=n=>n>=1048576?(n/1048576).toFixed(2)+'MB':Math.round(n/1024)+'KB';
    function sync(){ const dt=new DataTransfer(); files.slice(0,max).forEach(f=>dt.items.add(f)); input.files=dt.files; counter.textContent=`${files.length} / ${max} selected`; }
    function card(f,i){ const d=document.createElement('div'); d.className='thumb'; d.draggable=true; d.dataset.i = i;
      const im=document.createElement('img'); im.src=URL.createObjectURL(f);
      const m=document.createElement('div'); m.className='meta'; m.innerHTML=`<div class="name">${f.name}</div><div class="cap">${i===0?'<span class="good">Cover ¬∑ </span>':''}${fmt(f.size)}</div>`;
      const x=document.createElement('button'); x.className='del'; x.type='button'; x.textContent='√ó'; x.onclick=()=>{files.splice(i,1);render();};
      d.append(im,m,x);
      d.addEventListener('dragstart',e=>{d.classList.add('dragging');e.dataTransfer.setData('text/plain',i)});
      d.addEventListener('dragend',()=>d.classList.remove('dragging'));
      d.addEventListener('dragover',e=>e.preventDefault());
      d.addEventListener('drop',e=>{e.preventDefault();const from=+e.dataTransfer.getData('text/plain');const f2=files.splice(from,1)[0];files.splice(i,0,f2);render();});
      return d;
    }
    function render(){ list.innerHTML=''; files.forEach((f,i)=>list.appendChild(card(f,i))); sync(); }
    function accept(fs){ const add=[]; for(const f of fs){ if(!/image\/(jpeg|png|webp)/.test(f.type)) continue; if(f.size>2*1024*1024) continue; if(files.length+add.length>=max) break; add.push(f);} if(add.length){ files=files.concat(add); render(); } }
    add.onclick=()=>input.click(); clr.onclick=()=>{files=[];render();}; input.onchange=()=>accept(input.files||[]);
    area.onclick=()=>input.click(); area.ondragover=e=>{e.preventDefault();area.classList.add('dragover')}; area.ondragleave=()=>area.classList.remove('dragover');
    area.ondrop=e=>{e.preventDefault();area.classList.remove('dragover');accept(e.dataTransfer.files||[])};
    render();
  }
  document.querySelectorAll('.drop').forEach(initDrop);
</script>

<!-- Countries loader -->
<script>
(function(){
  function onReady(fn){ if(document.readyState==='loading') document.addEventListener('DOMContentLoaded',fn); else fn(); }
  onReady(async function(){
    const sel = document.getElementById('ctr');
    const hidden = document.getElementById('ctrCode');
    if(!sel) return;

    try {
      const res = await fetch('/data/meta/countries.json', { cache: 'no-store' });
      const list = await res.json();
      sel.innerHTML = '<option value="">‚Äî Select ‚Äî</option>';
      for (const {code, name} of list) {
        const opt = document.createElement('option');
        opt.value = name;
        opt.textContent = `${name} (${code})`;
        opt.dataset.code = code;
        sel.appendChild(opt);
      }
      sel.addEventListener('change', () => {
        const code = sel.selectedOptions[0]?.dataset?.code || '';
        if (hidden) hidden.value = code;
      });

      const preset = sel.getAttribute('data-preset') || sel.value;
      if (preset) {
        const lower = preset.toLowerCase();
        const match = Array.from(sel.options).find(o => o.value.toLowerCase() === lower);
        if (match) {
          sel.value = match.value;
          sel.dispatchEvent(new Event('change', { bubbles: true }));
        }
      }
    } catch (e) {
      console.error('countries.json load failed', e);
      const parent = sel.parentElement;
      const fallback = document.createElement('input');
      fallback.type = 'text';
      fallback.required = true;
      fallback.name = 'Country';
      fallback.id = 'ctr';
      fallback.placeholder = 'Country';
      parent.replaceChild(fallback, sel);
      if (hidden) hidden.remove();
    }
  });
})();
</script>

<!-- Prefill + counters + confirm + progress -->
<script>
(function(){
  function onReady(fn){ if(document.readyState==='loading') document.addEventListener('DOMContentLoaded',fn); else fn(); }
  onReady(function(){
    try {
      const sp = new URLSearchParams(location.search);
      const placeId = sp.get('placeId') || sp.get('place_id') || '';
      const placeName = sp.get('placeName') || sp.get('place_name') || '';
      const SHOW_PREFILL_INFO = false;

      function setField(names, val){
        if(!val) return false;
        for(const n of names){
          let el = document.querySelector(`[name="${n}"]`) || document.getElementById(n) ||
                   document.querySelector(`[name="${n.toLowerCase()}"]`) || document.getElementById(n.toLowerCase());
          if(!el) continue;
          const tag = el.tagName || '';
          if(tag==='INPUT' || tag==='TEXTAREA' || tag==='SELECT'){
            try{ el.value = val; }catch(_){}
            el.dispatchEvent(new Event('input',{bubbles:true}));
            el.dispatchEvent(new Event('change',{bubbles:true}));
          } else { el.textContent = val; }
          return true;
        }
        return false;
      }
      setField(['BusinessName','business_name','Business','PlaceName','place_name','name','business','bn'], placeName);

      if(placeId){
        setField(['ExistingPlaceId','existingplaceid','existingId','existing_id','placeId','place_id'], placeId);
        const form = document.getElementById('form-owner');
        if(form){
          let hi = form.querySelector('input[name="placeId"]');
          if(!hi){ hi = document.createElement('input'); hi.type='hidden'; hi.name='placeId'; form.appendChild(hi); }
          hi.value = placeId;
        }
      }

      // counters
      function bindCounter(textareaId, counterId, maxDefault){
        const ta=document.getElementById(textareaId);
        const sp=document.getElementById(counterId);
        if(!ta || !sp) return;
        const max=parseInt(ta.getAttribute('maxlength')||String(maxDefault),10);
        const upd=()=>{ const len=(ta.value||'').length; sp.textContent=`${len} / ${max}`; };
        ta.addEventListener('input',upd); upd();
      }
      bindCounter('about','about_left',600);
      bindCounter('paynote','pay_left',150);
      bindCounter('amen_notes','amen_left',150);

      // confirm modal
      const form = document.getElementById('form-owner');
      const btnReview = document.getElementById('btn-review');
      const modal = document.getElementById('confirmModal');
      const warnBox = document.getElementById('confirmWarnings');
      const btnBack = document.getElementById('btn-back');
      const btnSubmit = document.getElementById('btn-submit-final');

      function txt(n){ const el=form.querySelector(`[name="${n}"]`); return (el&&el.value||'').trim(); }
      function sel(n){ const el=form.querySelector(`[name="${n}"]`); return el && el.tagName==='SELECT' ? el.value : (el&&el.value||''); }
      function countImgs(){ const fi=form.querySelector('#gallery8'); return (fi&&fi.files&&fi.files.length)||0; }

      function limitWarn(label,val,max){
        if(!val) return null;
        if(val.length>max) return `‚ö†Ô∏é ${label}: ${val.length}/${max} ‚Äî server will trim to ${max}`;
        return null;
      }
      function buildConfirm(){
        document.getElementById('c_business').textContent = txt('BusinessName') || '‚Äî';
        document.getElementById('c_city').textContent = txt('City') || '‚Äî';
        document.getElementById('c_country').textContent = sel('Country') || txt('Country') || '‚Äî';
        document.getElementById('c_address').textContent = txt('Address') || '‚Äî';
        document.getElementById('c_category').textContent = sel('Category') || '‚Äî';
        document.getElementById('c_accepted').textContent = txt('Accepted') || '‚Äî';
        document.getElementById('c_about').textContent = txt('About') || '‚Äî';
        document.getElementById('c_paynote').textContent = txt('PaymentNote') || '‚Äî';
        document.getElementById('c_amen').textContent = txt('amenities_notes') || '‚Äî';
        document.getElementById('c_imgs').textContent = String(countImgs());

        const missing = [];
        ['SubmitterName','SubmitterEmail','BusinessName','City','Address','Accepted','Category'].forEach(n=>{ if(!txt(n) && !sel(n)) missing.push(n); });

        const warns = [];
        const w1 = limitWarn('About', txt('About'), 600);
        const w2 = limitWarn('Payment note', txt('PaymentNote'), 150);
        const w3 = limitWarn('Amenities notes', txt('amenities_notes'), 150);
        if(w1) warns.push(w1); if(w2) warns.push(w2); if(w3) warns.push(w3);
        if(missing.length) warns.push('Missing required: ' + missing.join(', '));

        if(warns.length){ warnBox.style.display='block'; warnBox.innerHTML = warns.map(s=>`<div>${s}</div>`).join(''); }
        else { warnBox.style.display='none'; warnBox.innerHTML=''; }
      }

      // ---- Progress overlay
      const ov = document.createElement('div');
      ov.id = 'cpmProgress';
      ov.className = 'cpm-progress';
      ov.innerHTML = '<div class="box"><h3>Submitting‚Ä¶</h3><div class="cpm-bar"><span id="cpmBar"></span></div><div id="cpmMsg" class="cpm-msg">Uploading files and creating a review PR‚Ä¶</div></div>';
      document.body.appendChild(ov);
      const bar = ()=>document.getElementById('cpmBar');
      let timer=null;
      function showProgress(msg){
        document.getElementById('cpmMsg').textContent = msg || 'Submitting‚Ä¶';
        ov.style.display='grid';
        let p=8; bar().style.width='8%';
        timer = setInterval(()=>{ p=Math.min(p+(p<70?Math.random()*10+5:Math.random()*5+1),94); bar().style.width=p+'%'; }, 600);
        document.body.style.overflow='hidden';
      }
      function hideProgress(){
        if(timer) clearInterval(timer);
        ov.style.display='none';
        document.body.style.overflow='';
      }

      function lockButtons(lock){
        btnSubmit.disabled = lock;
        btnReview.disabled = lock;
      }

      btnReview?.addEventListener('click', ()=>{ buildConfirm(); modal.style.display='grid'; document.body.style.overflow='hidden'; });
      btnBack?.addEventListener('click', ()=>{ modal.style.display='none'; document.body.style.overflow=''; });

      btnSubmit?.addEventListener('click', ()=>{
        modal.style.display='none';
        showProgress('Uploading files and creating a review PR‚Ä¶');
        lockButtons(true);
        form.submit(); // ÈÄöÂ∏∏POST„ÄÇ„Çµ„Éº„Éê„ÅßÂèóÁêÜÂæå„Å´ /forms/submitted.html „Å∏ 302
      });

      // ÈÄöÂ∏∏„ÅÆÁõ¥Êé• submitÔºàÁ¢∫Ë™ç„ÇíÈ£õ„Å∞„Åó„Å¶ÈÄÅ„Å£„ÅüÂ†¥ÂêàÔºâ„Åß„ÇÇÂøÖ„ÅöË°®Á§∫
      form.addEventListener('submit', ()=>{
        showProgress('Uploading files and creating a review PR‚Ä¶');
        lockButtons(true);
      });

      if(SHOW_PREFILL_INFO && (placeId || placeName)){
        const info = document.createElement('div');
        info.style.cssText='padding:10px;margin:8px 0;background:#f8fafc;border:1px solid #e6eef6;color:#0f172a;font-size:14px;';
        info.textContent='Prefilled: ' + (placeName || '') + (placeId ? ' ('+placeId+')' : '');
        const container=document.querySelector('main.container')||document.body;
        container.insertBefore(info, container.firstChild);
      }
    } catch (e) {
      console.error('owner form init error', e);
    }
  });
})();
</script>
</body>
</html>

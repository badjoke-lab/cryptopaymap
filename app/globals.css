@tailwind base;
@tailwind components;
@tailwind utilities;
@import 'leaflet/dist/leaflet.css';

/* ---------- Leaflet pane ordering ---------- */
.leaflet-tile-pane      { z-index: 200 !important; }
.leaflet-overlay-pane   { z-index: 400 !important; }
.leaflet-marker-pane    { z-index: 600 !important; }
.leaflet-popup-pane     { z-index: 700 !important; }
.leaflet-top, .leaflet-bottom { z-index: 800 !important; }

/* ---------- Modal ---------- */
.cpm-backdrop {
  position: fixed; inset: 0;
  background: rgba(0,0,0,.45);
  z-index: 2000 !important;
}
.cpm-modal {
  position: fixed; right: 0; top: 0;
  height: 100vh; width: min(420px,100vw);
  background:#fff; z-index: 2100 !important;
  display:flex; flex-direction:column;
  box-shadow:-14px 0 40px rgba(0,0,0,.25);
}
.cpm-modal__header {
  padding: 14px 16px;
  border-bottom: 1px solid #eee;
  display:flex; align-items:center; justify-content:space-between;
}
.cpm-modal__body { padding: 12px 16px; overflow:auto; }

/* ---------- Clusters & markers ---------- */
.cluster-green  { background:#86efac; border:3px solid #22c55e; color:#14532d; }
.cluster-yellow { background:#fde68a; border:3px solid #f59e0b; color:#713f12; }
.cluster-orange { background:#fdba74; border:3px solid #f97316; color:#7c2d12; }
.cluster-red    { background:#fca5a5; border:3px solid #ef4444; color:#7f1d1d; }
.cluster {
  border-radius:9999px;
  width:42px; height:42px;
  display:grid; place-items:center;
  font-weight:700;
  box-shadow:0 2px 6px rgba(0,0,0,.15);
}
.marker-dot {
  width:12px; height:12px;
  border-radius:9999px;
  background:#2563eb;
  border:2px solid #1d4ed8;
  box-shadow:0 1px 3px rgba(0,0,0,.25);
}

/* a11y */
:focus-visible { outline: 2px solid #2563eb; outline-offset: 2px; }

.leaflet-marker-icon,
.leaflet-marker-shadow {
  background: transparent !important;
  border: none !important;
}

/* ---------- Header / Nav ---------- */
header,
[data-site-header] {
  position: relative;
  width: 100%;
  background: #fff;
  border-bottom: 1px solid #e5e7eb;
  z-index: 5000;
}
header nav,
[data-site-nav] {
  display: flex; gap: 16px;
  white-space: nowrap;
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
  scrollbar-width: thin;
}
header nav a,
[data-site-nav] a { padding: 10px 0; }

/* ===== FINAL LOCK: header / layout consistency ===== */
:root { --header-h: 64px; }

header, [data-site-header]{
  position: fixed !important;
  top: 0 !important; left: 0 !important; right: 0 !important;
  height: var(--header-h) !important;
  background: #fff !important;
  border-bottom: 1px solid #e5e7eb !important;
  z-index: 2147483600 !important;
  -webkit-backface-visibility: hidden; backface-visibility: hidden;
  transform: translateZ(0);
}

/* ページ本文の押し下げ */
main, [data-page-root]{ padding-top: calc(var(--cpm-header-h, var(--header-h))) !important; }

/* ---------- Map layout ---------- */
.map-screen{
  position: fixed !important;
  top: calc(var(--cpm-header-h, var(--header-h))) !important;
  left: 0; right: 0; bottom: 0;
  overflow: hidden !important;
  z-index: 1 !important;
  border-top: 1px solid #e5e7eb;
}

/* Leafletホストを全域に広げる（MapShell の .map-canvas 用） */
.map-canvas{
  position: absolute !important;
  inset: 0 !important;
  height: 100% !important; width: 100% !important;
}

/* 互換: 直接 .leaflet-container を置いた場合も広げる */
.map-screen .leaflet-container{ height:100% !important; width:100% !important; }

/* ---------- z-index helpers ---------- */
.z-header{ z-index:50; } .z-fab{ z-index:40; } .z-sheet{ z-index:60; }
.z-backdrop{ z-index:55; } .z-leaflet{ z-index:30; } .z-credit{ z-index:20; }

/* ---------- Credit badge ---------- */
.cpm-credit {
  position:absolute; right: 10px; bottom: 10px;
  padding: 2px 6px; background: rgba(255,255,255,.85);
  border-radius: 6px; font-size: 12px;
}

/* === Popup text helpers === */
[data-badge] { letter-spacing: .01em; }
.cp-gallery img { aspect-ratio: 4/3; object-fit: cover; }
.cp-popup { word-break: break-word; }
.cp-popup .line-clamp-2 { display:-webkit-box; -webkit-box-orient:vertical; -webkit-line-clamp:2; overflow:hidden; }
.cp-popup .line-clamp-3 { display:-webkit-box; -webkit-box-orient:vertical; -webkit-line-clamp:3; overflow:hidden; }

/* ---------- Map toolbar (responsive) ---------- */
/* 基本: 中央寄せ・縦中央揃え・可変幅・横スクロール許可（折返しなし） */
.map-toolbar{
  position:absolute; top:8px; left:50%; transform:translateX(-50%);
  z-index:1200;
  display:flex; align-items:center;
  gap:12px; padding:10px 12px; border-radius:14px;
  background: rgba(255,255,255,.92); backdrop-filter: saturate(140%) blur(6px);
  box-shadow: 0 4px 16px rgba(0,0,0,.12);
  flex-wrap: nowrap;
  white-space: nowrap;
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
}
.map-toolbar label{ font-size:12px; opacity:.7; display:inline-flex; align-items:center; }
.map-toolbar select{
  font-size:14px; padding:.35rem .6rem;
  border:1px solid #d1d5db; border-radius:.6rem; background:#fff;
  min-width: 110px; max-width: 200px;
}

/* 640–1023px: 2行化（中央配置は維持） */
@media (max-width: 1023px){
  .map-toolbar{
    flex-wrap: wrap;
    row-gap: 8px;
    justify-content: center;
    max-width: calc(100vw - 16px);
  }
}

/* 360–639px: 横スクロールのまま（折返ししない） */
@media (max-width: 639px){
  .map-toolbar{ flex-wrap: nowrap; }
  .map-toolbar select{ min-width: 120px; }
}

/* 右ドック用トリガー（超狭小やレガシー時に使用） */
.map-filter-fab{
  position:absolute; right:10px; top:50%;
  transform: translateY(-50%);
  z-index: 1200;
  display: inline-flex; align-items: center; justify-content: center;
  width:48px; height:48px; border-radius:9999px;
  background:#111; color:#fff; font-weight:600;
  box-shadow:0 6px 18px rgba(0,0,0,.22);
  cursor: pointer;
}

/* 右ドック本体 */
.map-filter-drawer{
  position: fixed; right: 0; top: calc(var(--cpm-header-h, var(--header-h)));
  height: calc(100vh - var(--cpm-header-h, var(--header-h)));
  width: min(88vw, 320px); max-width: 420px;
  background: #fff; z-index: 2000;
  box-shadow: -14px 0 40px rgba(0,0,0,.25);
  display:flex; flex-direction:column;
}
.map-filter-drawer__header{
  display:flex; align-items:center; justify-content:space-between;
  padding: 12px 14px; border-bottom: 1px solid #eee; font-weight:700;
}
.map-filter-drawer__body{
  padding: 12px 14px; overflow-y:auto;
  display:flex; flex-direction:column; gap:10px;
}
.map-filter-backdrop{
  position: fixed; inset: 0; z-index: 1990; background: rgba(0,0,0,.35);
}

/* 右ドックの中のフォーム */
.map-filter-drawer label{ font-size: 12px; opacity:.7; }
.map-filter-drawer select{
  width: 100%;
  font-size:14px; padding:.5rem .6rem;
  border:1px solid #d1d5db; border-radius:.6rem; background:#fff;
}

/* Drawer 強制モード（超狭幅判定時に上書き） */
@media (max-width: 359px){
  .map-toolbar{ display:none !important; }
  .map-filter-fab{ display:inline-flex; }
}
@media (min-width: 360px){
  .map-filter-fab{ display:none; }
}
